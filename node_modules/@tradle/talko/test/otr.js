require('sock-plex')
var fs = require('fs')
var assert = require('assert')
var otr = require('otr')
var OTR = otr.OTR
var DSA = otr.DSA
var Client = require('../lib/messenger')
var msgs = require('./fixtures/strings')
var keys = require('otr/dsaKeys')
var keyCounter = 0

var aPort = 12321
var bPort = 32123

var a = new Client({
  port: bPort,
  localPort: aPort
})

var b = new Client({
  port: aPort,
  localPort: bPort
})

var aOtr = newOTR()
aOtr.ALLOW_V2 = false
aOtr.REQUIRE_ENCRYPTION = true
var bOtr = newOTR()
bOtr.ALLOW_V2 = false
bOtr.REQUIRE_ENCRYPTION = true

aOtr.on('io', function (msg) {
  a.send(msg)
})

bOtr.on('io', function (msg) {
  b.send(msg)
})

a.on('data', function (d) {
  aOtr.receiveMsg(d.toString())
})

b.on('data', function (d) {
  bOtr.receiveMsg(d.toString())
})

msgs.forEach(function (m, i) {
  var idx = m.indexOf('\x00')
  var idxs = []
  while (idx !== -1) {
    idxs.push(idx)
    idx = m.indexOf('\x00', idx + 1)
  }

  if (idxs.length) {
    msgs[i] = m.replace('\x00', '')
    console.log(idxs)
    fs.writeFileSync('./test/fixtures/strings.json', JSON.stringify(msgs, null, 2))
    console.log()
    throw new Error('invalid msg', m, idxs)
  }

  aOtr.sendMsg(m)
})

var counter = 0
bOtr.on('ui', function (data) {
  data = data.toString()
  console.log('equal', data === msgs[counter++])
  if (counter === msgs.length) {
    b.end()
  }
})

function newOTR () {
  return new OTR({
    priv: DSA.parsePrivate(keys[keyCounter++]),
    fragment_size: 200
  })
}
