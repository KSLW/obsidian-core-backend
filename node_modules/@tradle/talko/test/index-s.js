require('sock-plex')
var dgram = require('dgram')
var assert = require('assert')
var Client = require('../lib/messenger')
var msgs = require('./fixtures/strings')

var aPort = 12321
var bPort = 32123

var aSock1 = dgram.createSocket('udp4')
aSock1.bind(aPort)

var aSock2 = dgram.createSocket('udp4')
aSock2.bind(aPort)

var bSock1 = dgram.createSocket('udp4')
bSock1.bind(bPort)

var bSock2 = dgram.createSocket('udp4')
bSock2.bind(bPort)

var a = new Client({
  clientSocket: aSock1,
  serverSocket: aSock2,
  port: bPort
})

a.name = 'a'

var b = new Client({
  clientSocket: bSock1,
  serverSocket: bSock2,
  port: aPort
})

b.name = 'b'

msgs.forEach(function (m, i) {
  setTimeout(function () {
    a.send(m, function () {
      console.log('delivered')
    })
  }, i * 1000)
})

var counter = 0
b.on('data', function (data) {
  data = data.toString()
  counter++
  // console.log('equal', data === msgs[counter++])
  if (counter === msgs.length) {
    a.end()
    b.end()
  }
})

;[a, b].forEach(function (c) {
  ;['end', 'finish', 'close'].forEach(function (event) {
    c.once(event, function () {
      console.log((c === a ? 'a' : 'b'), event)
    })
  })
})

// setInterval(function () {
//   console.log(process._getActiveHandles())
// }, 2000).unref()
