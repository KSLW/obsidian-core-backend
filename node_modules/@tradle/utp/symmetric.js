
var util = require('util')
var Duplex = require('readable-stream').Duplex
var debug = require('debug')('SymmetricClient')
var net = require('./')

module.exports = Client

function Client (port) {
  var self = this

  Duplex.call(this, {
    allowHalfOpen: false
  })

  this._port = port
  this._cxn = null
  this._queue = []
  this._server = net.createServer(function (c) {
    self._debug('inbound connection')
    c.once('close', function () {
      self._debug('closed inbound connection')
    })

    self._inbound = true
    self._setConnection(c)
  })

  this._server.listen(port)
}

util.inherits(Client, Duplex)

Client.prototype._debug = function () {
  var args = [].slice.call(arguments)
  args.unshift(this._port)
  return debug.apply(null, args)
}

Client.prototype.connect = function (port, host) {
  var self = this
  if (this._closed) throw new Error('closed')
  if (this._cxn || this._connecting) return

  this._connecting = true
  var c = this._outboundCxn = net.connect(port, host)
  self._debug('new outbound connection')
  c.once('connect', function () {
    self._debug('outbound connection')
    self._outbound = true
    self._server.close()
    self._server = null
    self._setConnection(c)
  })

  c.once('close', function () {
    self._outboundCxn = null
    self._debug('closed outbound connection')
  })

  return c
}

Client.prototype._setConnection = function (c) {
  var self = this
  if (this._cxn) return c.destroy()
  if (this._inbound && this._outboundCxn) {
    this._outboundCxn.destroy()
    this._outboundCxn = null
  }

  this._cxn = c
  c.on('data', function (data) {
    self.push(data)
  })

  c.once('close', function () {
    self._cxn = null
    self._connecting = false
  })

  if (this._queue) {
    // TODO: determine if defensive copy is needed
    this._queue.forEach(this.send, this)
    this._queue.length = 0
  }
}

Client.prototype.send = function (data) {
  if (!this._cxn) return this._queue.push(data)

  this.write(data)
}

Client.prototype._read = function () {
  // do nothing
}

Client.prototype._write = function (data, enc, cb) {
  this._cxn.write.apply(this._cxn, arguments)
}

Client.prototype.close = function () {
  this._closed = true
  if (this._server) {
    this._debug('closing')
    this._server.close()
  } else if (this._cxn) {
    this._debug('closing')
    this._cxn.destroy()
  }
}
