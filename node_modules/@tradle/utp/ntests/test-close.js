var ID = 0;
function log(s) {
  s.id = ID++;
  ['finish', 'flush', 'end', 'close'].forEach(function(e) {
    s.on(e, function() {
      console.log(s.id, 'blah', e)
    })
  })
}

var utp = require('net');
var assert = require('assert');

var closed = 0;
var onclose = function(socket) {
  console.log('closed', socket.id)
  closed++;
  if (closed === 2) process.exit(0);
};

utp.createServer(function(socket) {
  log(socket)
  socket.resume();
  socket.on('end', function() {
    socket.end();
  });
  socket.on('close', onclose.bind(null, socket));
}).listen(53454);

var socket = utp.connect(53454);

log(socket)
socket.resume();
socket.on('close', onclose.bind(null, socket));
socket.end();

setTimeout(process.exit.bind(process, 1), 5000);

