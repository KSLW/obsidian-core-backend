
require('sock-plex')
var dgram = require('dgram')
// var createSocket = dgram.createSocket
// var sid = 0
// dgram.createSocket = function () {
//   var s = createSocket.apply(dgram, arguments)
//   s._socketId = sid++
//   // try {
//   //   throw new Error()
//   // } catch (err) {
//   //   err.stack.split('\n').forEach(function (line) {
//   //     console.log(s._socketId, line)
//   //   })
//   // }

//   // if (s._socketId === 2) throw new Error('blah')
//   return s
// }

var Client = require('./symmetric1')

var aPort = 12321
var bPort = 54345

var round = 0
// b.connect(aPort)

function oneRound (cb) {
  var i = 10
  round++
  var a = newClient(aPort, 'a')
  var b = newClient(bPort, 'b')
  a.connect(bPort)

  var interval = setInterval(function () {
    if (--i) {
      console.log('SENDING')
      a.send('hey' + i)
      b.send('yo' + i)
      return
    }

    a.close()
    if (cb) b.once('close', cb)
    clearInterval(interval)
  }, 100)

  function next () {
    setTimeout(cb, 200)
  }
}

function newClient (port, name) {
  var c = new Client(port)
  c.once('close', function () {
    console.log(name, 'closed')
  })

  c.on('data', function (data) {
    console.log('ROUND', round, name, 'got', data.toString())
  })

  return c
}

oneRound(function () {
  oneRound()
})

// setInterval(function () {
//   // console.log(cxns.map(function(c) {return c.socket._socketId}))
//   // cxns.forEach(function (c) { c.destroy() })
//   console.log(process._getActiveHandles().map(function (h) {
//     return h._socketId
//   }))
// }, 2000).unref()
