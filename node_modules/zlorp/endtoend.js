
var debug = require('debug')('blah-blah')
var assert = require('assert')
var dgram = require('dgram')
var fs = require('fs')
var bufferEquals = require('buffer-equal')
var pump = require('pump')
var map = require('map-stream')
// var lps = require('length-prefixed-stream')
var lps = require('frame-stream')
var OTR = require('otr').OTR
var keys = require('otr/test/spec/unit/data/keys')
var Client = require('rudp').Client
var buffers = require('./test/strings').map(Buffer)
var Readable = require('readable-stream').Readable
var utils = require('./lib/utils')
var toBuffer = utils.toBuffer
var toString = utils.fromBuffer

// console.log = function () {
//   debugger
// }

var aOtr = new OTR({
  debug: true,
  priv: keys.userA,
  fragment_size: 200
})

var bOtr = new OTR({
  debug: true,
  priv: keys.userB,
  fragment_size: 200
})

aOtr.REQUIRE_ENCRYPTION = true
bOtr.REQUIRE_ENCRYPTION = true

function works () {
  var file
  aOtr.on('ui', console.log)
  aOtr.on('io', function (data) {
    bOtr.receiveMsg(data)
  })

  bOtr.on('io', function (data) {
    aOtr.receiveMsg(data)
  })

  bOtr.on('ui', function (msg) {
    // assert.deepEqual(buffers.shift().toString(), msg)
    msg = toBuffer(msg)
    console.log('success:', bufferEquals(msg, file))
    // fs.writeFile('./blah.png', msg)
    // if (!buffers.length) {
    //   process.exit(0)
    // }
  })

  fs.readFile('./test/logo.png', function (err, buf) {
    file = buf
    aOtr.sendMsg(toString(buf))
  })
}

function works2 () {
  var i = 0
  aOtr.on('ui', console.log)
  aOtr.on('io', function (data) {
    bOtr.receiveMsg(data)
  })

  bOtr.on('io', function (data) {
    aOtr.receiveMsg(data)
  })

  bOtr.on('ui', function (msg) {
    // assert.deepEqual(buffers.shift().toString(), msg)
    msg = toBuffer(msg)
    console.log('success:', bufferEquals(msg, buffers[i++]))
    // fs.writeFile('./blah.png', msg)
    // if (!buffers.length) {
    //   process.exit(0)
    // }
  })

  buffers.forEach(function (buf) {
    aOtr.sendMsg(toString(buf))
  })
}

function works3 () {
  var i = 0
  var aEncoder = lps.encode()
  var aDecoder = lps.decode()
  var bEncoder = lps.encode()
  var bDecoder = lps.decode()
  aOtr.on('ui', console.log)
  aOtr.on('io', function (data) {
    aEncoder.write(new Buffer(data))
  })

  bOtr.on('io', function (data) {
    bEncoder.write(new Buffer(data))
  })

  aEncoder.on('data', function (data) {
    bDecoder.write(data)
  })

  bEncoder.on('data', function (data) {
    aDecoder.write(data)
  })

  aDecoder.on('data', function (data) {
    aOtr.receiveMsg(data.toString())
  })

  bDecoder.on('data', function (data) {
    bOtr.receiveMsg(data.toString())
  })

  aOtr.on('ui', function (data) {
    console.log('b says', data)
  })

  // bOtr.on('ui', function (data) {
  //   console.log('a says', data)
  // })

  bOtr.on('ui', function (msg) {
    // assert.deepEqual(buffers.shift().toString(), msg)
    msg = toBuffer(msg)
    console.log('success:', bufferEquals(msg, buffers[i++]))
    // fs.writeFile('./blah.png', msg)
    // if (!buffers.length) {
    //   process.exit(0)
    // }
  })

  buffers.forEach(function (buf) {
    aOtr.sendMsg(toString(buf))
  })
}

function works4 () {
  var a = dgram.createSocket('udp4')
  var b = dgram.createSocket('udp4')
  a.bind(11111, function () {
    b.bind(22222, function () {
      var i = 0
      var aClient = new Client(a, '127.0.0.1', b.address().port)
      var bClient = new Client(b, '127.0.0.1', a.address().port)

      aOtr.on('ui', console.log)
      aOtr.on('io', function (data) {
        aClient.send(new Buffer(data))
      })

      bOtr.on('io', function (data) {
        bClient.send(new Buffer(data))
      })

      aClient.on('data', function (data) {
        aOtr.receiveMsg(data.toString())
      })

      bClient.on('data', function (data) {
        bOtr.receiveMsg(data.toString())
      })

      aOtr.on('ui', function (data) {
        console.log('b says', data)
      })

      // bOtr.on('ui', function (data) {
      //   console.log('a says', data)
      // })

      bOtr.on('ui', function (msg) {
        // assert.deepEqual(buffers.shift().toString(), msg)
        msg = toBuffer(msg)
        console.log('success:', bufferEquals(msg, buffers[i++]))
        // fs.writeFile('./blah.png', msg)
        // if (!buffers.length) {
        //   process.exit(0)
        // }
      })

      buffers.forEach(function (buf) {
        aOtr.sendMsg(toString(buf))
      })
    })
  })
}

function works5 () {
  var a = dgram.createSocket('udp4')
  var b = dgram.createSocket('udp4')
  a.bind(11111, function () {
    b.bind(22222, function () {
      var file
      var aClient = new Client(a, '127.0.0.1', b.address().port)
      var bClient = new Client(b, '127.0.0.1', a.address().port)

      aOtr.on('io', function (data) {
        // console.log('send', data.toString())
        aClient.send(new Buffer(data))
      })

      bOtr.on('io', function (data) {
        bClient.send(new Buffer(data))
      })

      aClient.on('data', function (data) {
        aOtr.receiveMsg(data.toString())
      })

      bClient.on('data', function (data) {
        bOtr.receiveMsg(data.toString())
      })

      bOtr.on('ui', function (msg) {
        msg = toBuffer(msg)
        console.log('success:', bufferEquals(msg, file))
        console.log()
        console.log()
        console.log()
        process.exit(0)
      })

      fs.readFile('./test/logo.png', function (err, buf) {
        if (err) throw err

        file = buf
        aOtr.sendMsg(toString(buf))
      })
    })
  })
}

function works6 () {
  var a = dgram.createSocket('udp4')
  var b = dgram.createSocket('udp4')
  a.bind(11111, function () {
    b.bind(22222, function () {

      // buffers.forEach(function (data) {
      //   aOtr.sendMsg(data.toString())
      // })

      // if (true) return

      var aClient = new Client(a, '127.0.0.1', b.address().port)
      var bClient = new Client(b, '127.0.0.1', a.address().port)

      var aEncoder = lps.encode()
      var aDecoder = lps.decode()
      var bEncoder = lps.encode()
      var bDecoder = lps.decode()

      aOtr.on('io', function (data) {
        aEncoder.write(new Buffer(data))
        // bOtr.receiveMsg(data)
      })

      bOtr.on('io', function (data) {
        bEncoder.write(new Buffer(data))
      })

      aOtr.on('ui', console.log.bind(console, 'b says'))
      bOtr.on('ui', function (msg) {
        console.log('checking', buffers[0].toString())
        assert.deepEqual(msg, buffers.shift().toString())
        // fs.writeFile('./blah.png', toBuffer(msg))
        if (!buffers.length) {
          // aOtr.endOtr(function () {
          //   aClient.close()
          // })

          // bOtr.endOtr(function () {
          //   bClient.close()
          // })
          process.exit(0)
        }
      })

      aEncoder.on('data', function (data) {
        aClient.send(data)
      })

      bEncoder.on('data', function (data) {
        bClient.send(data)
      })

      aClient.on('data', function (data) {
        aDecoder.write(data)
      })

      bClient.on('data', function (data) {
        bDecoder.write(data)
      })

      aDecoder.on('data', function (data) {
        // console.log(data.toString())
        aOtr.receiveMsg(data.toString())
      })

      bDecoder.on('data', function (data) {
        console.log(data.toString())
        if (/^OTR/.test(data.toString())) debugger
        bOtr.receiveMsg(data.toString())
      })

      buffers.forEach(function (data) {
        aOtr.sendMsg(data)
      })

      // fs.readFile('./test/logo.png', function (err, buf) {
      //   if (err) throw err

      //   aOtr.sendMsg(buf.toString())
      // })

      if (true) return

      // encrypt
      encoder.on('data', function (data) {
        aOtr.sendMsg(toString(data))
      })

      aOtr.on('ui', function (data) {
        console.log('a got', data)
      })

      // send
      aOtr.on('io', function (data) {
        aClient.send(toBuffer(data))
      })

      // receive, decrypt
      bClient.on('data', function (data) {
        bOtr.receiveMsg(toString(data))
      })

      // decode
      bOtr.on('ui', function (data) {
        console.log('b got', data)
        decoder.write(toBuffer(data))
      })

      // output

      // other direction
      aClient.on('data', function (data) {
        aOtr.receiveMsg(toString(data))
      })

      bOtr.on('io', function (data) {
        bClient.send(toBuffer(data))
      })

      // encode
      buffers.forEach(encoder.write, encoder)
      decoder.pipe(process.stdout)
    })
  })
}

return works5()

// process.stdin.resume()
// process.stdin.pipe(encoder)


// input -> encoder -> otr -> encoder -> rudp -> decoder -> otr -> encoder -> output
// input -> encoder -> otr -> encoder -> rudp -> decoder -> otr -> encoder -> output


//     // strings.forEach(input.push, input)
//     fs.readFile('./test/logo.png', function (err, buf) {
//       // encoder.write(buf)
//       input.push('jey thereaabl!')
//       // input.push(buf)
//       input.push('aaaaaaaaaaaaaaaaaaaaaaaaahhhhh!')
//       input.push(null)
//     })

//     function run (input) {
//       var togo = 3
//       var i = 0
//       pump(
//         input,
//         e1,
//         otrTransform.encode(aOtr),
//         // e2,
//         // ra,
//         // rb,
//         // d2,
//         otrTransform.decode(bOtr),
//         d1
//       ).on('data', function (d) {
//           console.log(d)
//           if (i++ === 1) {
//             fs.writeFile('blah.png', d)
//           }

//           if (i === togo) {
//             ac.close()
//             bc.close()
//           }
//         })
//         // .on('end', process.exit.bind(process, 0))
//     }
//   })
// })
























// utf8 -> base64 ->

// input -> otr -> encoder -> rudp -> decoder -> otr -> output
