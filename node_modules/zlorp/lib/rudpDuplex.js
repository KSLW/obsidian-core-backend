var duplexify = require('duplexify')
var Stream = require('readable-stream')

module.exports = rudpDuplex

function rudpDuplex (client) {
  var readable = new Stream.Readable()
  readable._read = function () {
    // do nothing
  }

  client.on('data', function (data) {
    readable.push(data)
  })

  var writable = new Stream.Writable()
  writable._write = function (data, enc, cb) {
    client.send(data)
    cb()
  }

  var d = duplexify(writable, readable, { allowHalfOpen: false })
  var closed

  d.on('end', function () {
    console.log('ended')
  })

  d.on('finish', function () {
    console.log('finished')
  })

  d.on('close', function () {
    console.log('closed')
    if (!closed) client.close()
  })

  client.on('close', function () {
    if (closed) return
// process._getActiveHandles()[0]

    closed = true
    d.end()
  })

  return d
}

// function toRUDP (client) {
//   return through(function (data, enc, cb) {
//     client.send(data)
//     cb()
//   })
// }

// function fromRUDP (client) {
//   return through(function (data, enc, cb) {
//     client.receiveMsg(data)
//     cb()
//   })

//   client.on('ui', function (data) {
//     stream.push(data)
//   })

//   client.once('close', function () {
//     stream.push(null)
//   })

//   return stream
// }

// var dgram = require('dgram')
// var Client = require('rudp').Client
// var as = dgram.createSocket('udp4')
// var bs = dgram.createSocket('udp4')
// as.bind(function () {
//   bs.bind(function () {
//     var a = new Client(as, '127.0.0.1', bs.address().port)
//     var b = new Client(bs, '127.0.0.1', as.address().port)
//     b.on('data', function (data) {
//       b.send(data)
//     })

//     process.stdin.resume()
//     process.stdin
//       .pipe(rudpDuplex(a))
//       .pipe(process.stdout)
//   })
// })
