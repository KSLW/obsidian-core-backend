var CONST = require('otr').OTR.CONST
var through = require('through2')

module.exports = {
  encode: toOTR,
  decode: fromOTR
}

function toOTR (otr) {
  var log = logger(otr)
  var stream = through(function (data, enc, cb) {
    otr.sendMsg(data, cb)
  })

  otr.on('io', function (data) {
    stream.push(data)
  })

  otr.on('status', function (status) {
    if (status === CONST.STATUS_END_OTR) {
      stream.push(null)
    }
  })

  return stream
}

function fromOTR (otr) {
  // var callbacks = []
  var log = logger(otr)
  var stream = through(function (data, enc, cb) {
    otr.receiveMsg(data.toString())
    cb()
  })

  otr.on('ui', function (data) {
    log('ui', data)
    stream.push(data)
    // callbacks.shift()()
  })

  otr.on('status', function (status) {
    if (status === CONST.STATUS_END_OTR) {
      stream.push(null)
    }
  })

  return stream
}

function logger (otr) {
  return function () {
    var args = [].slice.call(arguments, 0)
    args.unshift(otr.our_instance_tag)
    return console.log.apply(console, args)
  }
}

// var OTR = require('otr').OTR
// var keys = require('otr/test/spec/unit/data/keys')
// var aOtr = new OTR({
//   priv: keys.userA
// })

// var bOtr = new OTR({
//   priv: keys.userB
// })

// process.stdin.resume()
// process.stdin.pipe(toOTR(aOtr)).pipe(fromOTR(bOtr)).pipe(process.stdout)
