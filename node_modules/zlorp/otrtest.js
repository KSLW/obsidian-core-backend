var assert = require('assert')
var OTR = require('otr').OTR
var CONST = require('otr/lib/const')
var keys = require('otr/test/spec/unit/data/keys')
var errEvents = ['warn', 'error']

var msgs = [
  'Hope this works.',
  'Second message.', 'Third!', '4', '5', '6', '7',
  '8888888888888888888'
]
var counter = 0
var ui = function (msg) {
  assert.equal(msgs[counter++], msg, 'Encrypted message.')
  if (counter > 7) process.exit()
  else {
    var m = msgs[counter]
    console.log('sending msg', m)
    this.sendMsg(msgs[counter], function () {
      console.log('sent msg', m)
    })
  }
}

var err = function (e) {
  if (e) throw e
}

var io = function (msg) { userB.receiveMsg(msg) }
var userA = new OTR({ priv: keys.userA })
userA.on('ui', ui.bind(userA))
userA.on('io', io)
onErrOrWarn(userA, err)
var userB = new OTR({ priv: keys.userB })
userB.on('ui', ui.bind(userB))
onErrOrWarn(userB, err)
userB.on('io', userA.receiveMsg)
userA.sendQueryMsg()
userB.on('status', function (yay) {
  if (yay === CONST.STATUS_AKE_SUCCESS) {
    assert.equal(userA.msgstate, CONST.MSGSTATE_ENCRYPTED, 'Encrypted')
    assert.equal(userB.msgstate, CONST.MSGSTATE_ENCRYPTED, 'Encrypted')
    userB.sendMsg(msgs[counter])
  }
})

function onErrOrWarn (emitter, handler) {
  errEvents.forEach(function (event) {
    emitter.on(event, handler)
  })
}
