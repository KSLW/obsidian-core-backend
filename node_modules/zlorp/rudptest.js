
var fs = require('fs')
var pump = require('pump')
var map = require('map-stream')
var lps = require('length-prefixed-stream')
var OTR = require('otr').OTR
var keys = require('otr/test/spec/unit/data/keys')
var Relay = require('dht-relay')
var Client = require('rudp').Client
var otrTransform = require('./lib/otrTransform')
var rudpDuplex = require('./lib/rudpDuplex')
var strings = require('./test/strings')
var Readable = require('readable-stream').Readable

var relayAddr = {
  address: '127.0.0.1',
  port: 33333
}

var encoder = lps.encode()
var decoder = lps.decode()
var relay = Relay.createServer(relayAddr.port)
var a = Relay.createClient(relayAddr)
var b = Relay.createClient(relayAddr)
a.bind(11111, function () {
  b.bind(22222, function () {
    var ac = new Client(a, '127.0.0.1', b.address().port)
    var ra = rudpDuplex(ac)
    var aOtr = new OTR({
      priv: keys.userA
    })

    var bc = new Client(b, '127.0.0.1', a.address().port)
    var rb = rudpDuplex(bc)
    var bOtr = new OTR({
      priv: keys.userB
    })

    aOtr.REQUIRE_ENCRYPTION = true
    bOtr.REQUIRE_ENCRYPTION = true

    var e1 = lps.encode()
    var d1 = lps.decode()

    var e2 = lps.encode()
    var d2 = lps.decode()

    // process.stdin.resume()
    // process.stdin
      // .pipe(e1)

    var input = new Readable()
    input._read = function () {}

    run(input)
    // strings.forEach(input.push, input)
    fs.readFile('./test/logo.png', function (err, buf) {
      // encoder.write(buf)
      input.push('jey thereaabl!')
      // input.push(buf)
      input.push('aaaaaaaaaaaaaaaaaaaaaaaaahhhhh!')
      input.push(null)
    })

    function run (input) {
      var togo = 3
      var i = 0
      pump(
        input,
        e1,
        otrTransform.encode(aOtr),
        // e2,
        // ra,
        // rb,
        // d2,
        otrTransform.decode(bOtr),
        d1
      ).on('data', function (d) {
          console.log(d)
          if (i++ === 1) {
            fs.writeFile('blah.png', d)
          }

          if (i === togo) {
            ac.close()
            bc.close()
          }
        })
        // .on('end', process.exit.bind(process, 0))
    }
  })
})

// input -> encoder -> otr -> encoder -> rudp -> decoder -> otr -> encoder -> outpuer

